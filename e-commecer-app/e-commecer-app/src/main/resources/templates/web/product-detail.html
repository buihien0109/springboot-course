<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org"
      th:replace="~{web/layout/layout :: layout(~{:: title}, ~{:: #css}, ~{:: #content}, ~{:: #js})}">

<head>
    <title th:text="${product.name}">Product Detail</title>

    <th:block id="css">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/paginationjs/2.6.0/pagination.min.css"
              integrity="sha512-K1k7jSn9RDKEcn/ugqVVvWYu0bcS3q1w6m/5pQSnrj0bCfIqF6Wk49lkmckSb4wglvTP9V17LtS0q0XxYccXbg=="
              crossorigin="anonymous" referrerpolicy="no-referrer"/>
    </th:block>
</head>

<body>
<th:block id="content">
    <!-- Breadcrumb Section Begin -->
    <section class="breadcrumb-section set-bg" style="background-image: url(/img/breadcrumb.jpg)">
        <div class="container">
            <div class="row">
                <div class="col-lg-12 text-center">
                    <div class="breadcrumb__text">
                        <div class="breadcrumb__option">
                            <a href="/">Trang chủ</a>
                            <a th:href="@{/danh-muc/{name} (name=${product.category.name})}"
                               th:text="${product.category.name}">Vegetables</a>
                            <span th:text="${product.name}">Vegetable’s Package</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>
    <!-- Breadcrumb Section End -->

    <!-- Product Details Section Begin -->
    <section class="product-details spad">
        <div class="container">
            <div class="row">
                <div class="col-lg-6 col-md-6">
                    <div class="product__details__pic">
                        <div class="product__details__pic__item">
                            <img class="product__details__pic__item--large"
                                 th:src="${product.images.mainImage != null ? product.images.mainImage.imageUrl : '/img/image-placeholder.png'}" alt="">
                        </div>
                        <div class="product__details__pic__slider owl-carousel">
                            <th:block th:if="not ${#lists.isEmpty(product.images.subImages)}">
                                <img th:each="image : ${product.images.subImages}" th:data-imgbigurl="${image.imageUrl}"
                                     th:src="${image.imageUrl}" alt="">
                            </th:block>
                        </div>
                    </div>
                </div>
                <div class="col-lg-6 col-md-6">
                    <div class="product__details__text">
                        <h3 th:text="${product.name}">Vetgetable’s Package</h3>
                        <div class="product__details__rating d-flex align-items-center">
                            <div class="rating mr-1">

                            </div>
                            <span>(<span class="review-count d-inline-block m-0">18</span> đánh giá)</span>
                        </div>
                        <div class="product__details__price"
                             th:classappend="${product.discountPrice != null} ? 'has-discount' : ''">
                            <span th:if="${product.discountPrice != null}"
                                  class="currency"
                                  th:classappend="${product.discountPrice != null} ? 'discount-price' : ''"
                                  th:text="${product.discountPrice}"></span>
                            <span class="currency"
                                  th:classappend="${product.discountPrice != null} ? 'original-price' : ''"
                                  th:text="${product.price}"></span>
                        </div>
                        <p th:text="${product.description}">Mauris blandit aliquet elit, eget tincidunt nibh pulvinar a.
                            Vestibulum ac diam sit amet quam
                            vehicula elementum sed sit amet dui. Sed porttitor lectus nibh. Vestibulum ac diam sit amet
                            quam vehicula elementum sed sit amet dui. Proin eget tortor risus.</p>
                        <div class="product__details__quantity">
                            <div class="quantity">
                                <div class="pro-qty">
                                    <span class="dec qtybtn">-</span>
                                    <input type="text" value="1" readonly>
                                    <span class="inc qtybtn">+</span>
                                </div>
                            </div>
                        </div>
                        <button class="border-0 primary-btn btn-add-to-card">THÊM VÀO GIỎ HÀNG</button>
                        <button class="border-0 heart-icon btn-add-to-wishlist"><span class="icon_heart_alt"></span>
                        </button>
                        <ul>
                            <li><b>Tình trạng</b> <span th:if="${product.stockQuantity == 0 ? 'Hết hàng' : 'Còn hàng'}">Còn hàng</span>
                            </li>
                            <li th:if="${product.stockQuantity > 0}"><b>Số lượng</b> <span
                                    th:text="${product.stockQuantity}">1</span></li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </section>
    <!-- Product Details Section End -->
    <section class="review-section">
        <div class="container">
            <div class="row">
                <div class="col-lg-12">
                    <div class="product__details__tab">
                        <ul class="nav nav-tabs" role="tablist">
                            <li class="nav-item">
                                <a class="nav-link" data-toggle="tab" href="#tabs-1" role="tab"
                                   aria-selected="true">Thông tin sản phẩm</a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link active" data-toggle="tab" href="#tabs-2" role="tab"
                                   aria-selected="false">Đánh giá <span>(<span
                                        class="review-count d-inline-block m-0"></span>)</span></a>
                            </li>
                        </ul>
                        <div class="tab-content">
                            <div class="tab-pane" id="tabs-1" role="tabpanel">
                                <div class="product__details__tab__desc">
                                    <h6>Thông tin sản phẩm</h6>

                                    <p th:each="attribute : ${product.getAttributes()}">
                                        <span th:text="${attribute.attributeName}"></span>:
                                        <span th:text="${attribute.attributeValue}"></span>
                                    </p>
                                </div>
                            </div>
                            <div class="tab-pane active" id="tabs-2" role="tabpanel">
                                <div class="product__details__tab__desc">
                                    <div class="review-overview mb-5 bg-white p-4">
                                        <div class="row">
                                            <div class="col-md-4">
                                                <div class="overview-avg d-flex justify-content-center align-items-center flex-column h-100">
                                                    <p>Đánh Giá Trung Bình</p>
                                                    <h2></h2>
                                                    <div class="rating mb-2">

                                                    </div>
                                                    <p class="mb-0"><span class="review-count d-inline-block m-0"></span> đánh giá</p>
                                                </div>
                                            </div>
                                            <div class="col-md-4">
                                                <div class="overview-progress d-flex justify-content-center align-items-center flex-column h-100">
                                                    <div class="progress-block w-100">
                                                        <div class="progress-item d-flex align-items-center w-100 mb-1">
                                                            <span class="mr-1">5</span>
                                                            <span class="mr-1 rating"><i class="fa fa-star"></i></span>
                                                            <div class="flex-grow-1 progress progress-success progress-sm progress-line">
                                                                <div class="progress-bar" style="width: 48%;"></div>
                                                            </div>
                                                            <span class="ml-1">10</span>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="col-md-4">
                                                <div class="d-flex justify-content-center align-items-center flex-column h-100">
                                                    <p>Bạn đã mua sản phẩm này?</p>
                                                    <button class="border-0 primary-btn btn-create-review">Gửi đánh giá
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="review-list">

                                    </div>
                                    <div class="pagination-container mt-4">
                                        <div id="review-pagination" class="d-flex justify-content-center"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Modal -->
    <div class="modal fade" id="modal-review" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="exampleModalLabel">Đánh giá sản phẩm</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="review-product-info text-center">
                        <img th:src="${product.images.mainImage != null ? product.images.mainImage.imageUrl : '/img/image-placeholder.png'}" alt="">
                        <p th:text="${product.name}"></p>
                    </div>
                    <div class="review-product-rating">
                        <div class="text-center">
                            <span class="review-product-rating-item" data-rating="1" data-message="Không thích"><i
                                    class="fa fa-star"></i></span>
                            <span class="review-product-rating-item" data-rating="2" data-message="Tạm được"><i
                                    class="fa fa-star"></i></span>
                            <span class="review-product-rating-item" data-rating="3" data-message="Bình thường"><i
                                    class="fa fa-star"></i></span>
                            <span class="review-product-rating-item" data-rating="4" data-message="Hài lòng"><i
                                    class="fa fa-star"></i></span>
                            <span class="review-product-rating-item" data-rating="5" data-message="Tuyệt vời"><i
                                    class="fa fa-star"></i></span>
                        </div>
                        <div class="text-center">
                            <p class="review-product-rating-result"></p>
                        </div>
                    </div>
                    <div class="review-product-content">
                        <textarea id="review-content" placeholder="Hãy chia sẻ cảm nhận của bạn về sản phẩm"></textarea>
                    </div>
                    <div class="review-product-btn d-flex justify-content-center">
                        <button class="border-0 primary-btn mt-2" id="btn-send-review">Hoàn tất</button>
                    </div>

                </div>
            </div>
        </div>
    </div>

    <!-- Related Product Section Begin -->
    <section class="related-product">
        <div class="container">
            <div class="row">
                <div class="col-lg-12">
                    <div class="section-title related__product__title">
                        <h2>Sản phẩm liên quan</h2>
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="col-lg-3 col-md-4 col-sm-6" th:each="rProduct : ${relatedProducts}">
                    <div class="product__item">
                        <div class="product__item__pic set-bg"
                             th:style="|background-image: url(${rProduct.images.mainImage != null ? rProduct.images.mainImage.imageUrl : '/img/image-placeholder.png'})|">
                            <ul class="product__item__pic__hover">
                                <li><a href="javascript:void(0)" th:onclick="|addToWishList(${rProduct.productId})|"><i
                                        class="fa fa-heart"></i></a></li>
                                <li><a href="javascript:void(0)" th:onclick="|addToCart(${rProduct.productId}, 1)|"><i
                                        class="fa fa-shopping-cart"></i></a></li>
                            </ul>
                        </div>
                        <div class="product__item__text">
                            <h6><a th:href="@{/san-pham/{id} (id=${rProduct.productId})}" th:text="${rProduct.name}">Sản
                                phẩm 1</a></h6>
                            <div th:classappend="${rProduct.discountPrice != null} ? 'product-item-price' : ''">
                                <h5 th:if="${rProduct.discountPrice != null}" th:text="${rProduct.discountPrice}"
                                    class="discount-price currency"></h5>
                                <h5 th:text="${rProduct.price}"
                                    class="currency"
                                    th:classappend="${rProduct.discountPrice != null ? 'original-price' : ''}">$100</h5>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>
    <!-- Related Product Section End -->
</th:block>

<th:block id="js">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/paginationjs/2.6.0/pagination.min.js"
            integrity="sha512-GzbaI5EsNzdEUq6/2XLYpr1y9CUZRIVsUeWTAFgULtQa5jZ3Nug8i0nZKM6jp9NffBCZhymPPQFcF0DK+JkRpw=="
            crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script th:inline="javascript">
        const product = [[${product}]];
        const reviews = [[${reviews}]];
        console.log({product, reviews});

        let idUpdate = null;
        let isUpdate = false;

        /*---------------------------------
            Product Details Pic Slider
        ----------------------------------*/
        $(".product__details__pic__slider").owlCarousel({
            margin: 20,
            items: 4,
            dots: true,
            smartSpeed: 1200,
            autoHeight: false,
            autoplay: true,
            center: true,
            loop: true,
        });

        /*------------------
            Single Product
        --------------------*/
        $('.product__details__pic__slider img').on('click', function () {
            var imgurl = $(this).data('imgbigurl');
            var bigImg = $('.product__details__pic__item--large').attr('src');
            if (imgurl != bigImg) {
                $('.product__details__pic__item--large').attr({
                    src: imgurl
                });
            }
        });

        /*-------------------
            Quantity change
        --------------------- */
        let quantity = 1;
        const quantityInput = document.querySelector('.pro-qty input');
        const quantityBtns = document.querySelectorAll('.pro-qty .qtybtn');
        quantityBtns.forEach(btn => {
            btn.addEventListener("click", () => {
                if (quantity >= product.stockQuantity) {
                    alert("Số lượng sản phẩm không đủ");
                    return;
                }
                if (btn.classList.contains("inc")) {
                    quantity++;
                } else if (btn.classList.contains("dec") && quantity > 1) {
                    quantity--;
                }
                quantityInput.value = quantity;
            })
        })

        /*-------------------
            Add to cart
        --------------------- */
        const btnAddToCart = document.querySelector('.btn-add-to-card');
        // Send request to server
        btnAddToCart.addEventListener('click', () => {
            addToCart(product.productId, quantity);
        })

        /*-------------------
            Add to wishlist
        --------------------- */
        const btnAddToWishlist = document.querySelector('.btn-add-to-wishlist');
        // Send request to server
        btnAddToWishlist.addEventListener("click", () => {
            addToWishList(product.productId);
        })

        // click button to open modal review
        const btnCreateReview = document.querySelector(".btn-create-review");
        btnCreateReview.addEventListener("click", () => {
            $('#modal-review').modal('show');
        })

        /*-------------------
            Rating change
        --------------------- */
        const stars = document.querySelectorAll(".review-product-rating-item");
        const ratingMessage = document.querySelector(".review-product-rating-result");
        let currentRating = 0;
        let currentMessage = "";

        stars.forEach((star) => {
            star.addEventListener("mouseover", () => {
                resetStars();
                const rating = parseInt(star.getAttribute("data-rating"));
                highlightStars(rating);
            });

            star.addEventListener("mouseout", () => {
                resetStars();
                highlightStars(currentRating);
            });

            star.addEventListener("click", () => {
                currentRating = parseInt(star.getAttribute("data-rating"));
                currentMessage = star.getAttribute("data-message");
                ratingMessage.textContent = `Bạn đã đánh giá ${currentRating} sao. (${currentMessage})`;
                highlightStars(currentRating);
            });
        });

        function resetStars() {
            stars.forEach((star) => {
                star.classList.remove("active");
            });
        }

        function highlightStars(rating) {
            stars.forEach((star) => {
                const starRating = parseInt(star.getAttribute("data-rating"));
                if (starRating <= rating) {
                    star.classList.add("active");
                }
            });
        }

        function reviewMessage(rating) {
            switch (rating) {
                case 1:
                    return "Không thích";
                case 2:
                    return "Tạm được";
                case 3:
                    return "Bình thường";
                case 4:
                    return "Hài lòng";
                case 5:
                    return "Tuyệt vời";
                default:
                    return "";
            }
        }

        const formatDate = dateString => {
            const date = new Date(dateString);
            const day = `0${date.getDate()}`.slice(-2);
            const month = `0${date.getMonth() + 1}`.slice(-2);
            const year = date.getFullYear();
            const hour = `0${date.getHours()}`.slice(-2);
            const minute = `0${date.getMinutes()}`.slice(-2);
            const second = `0${date.getSeconds()}`.slice(-2);
            return `${hour}:${minute}:${second} - ${day}/${month}/${year}`;
        }

        /*-------------------
            render review
        --------------------- */
        const renderReview = review => {
            let ratingHtml = "";
            for (let i = 0; i < 5; i++) {
                if (i < review.rating) {
                    ratingHtml += `<span class="active"><i class="fa fa-star"></i></span>`
                } else {
                    ratingHtml += `<span class="unactive"><i class="fa fa-star"></i></span>`
                }
            }
            return `
            <div class="review-item">
                <div class="review-avatar">
                    <img src="${review.authorAvatar}" alt="">
                </div>
                <div class="review-info">
                    <div class="d-flex align-items-center mb-2">
                        <p class="author mr-2 my-0">${review.authorName}</p> <span class="time">${formatDate(review.updatedAt)}</span>
                    </div>
                    <div class="rating mb-2 d-flex align-items-center">
                        ${ratingHtml}
                    </div>
                    <p class="content">${review.comment}</p>
                    ${
                isLogin && currentUser.userId === review.authorId
                    ? `
                            <div>
                                <button class="border-0 bg-transparent btn-edit-review text-primary" onclick="openModalToUpdateReview(${review.reviewId})">Sửa</button>
                                <button class="border-0 bg-transparent btn-delete-review text-primary" onclick="deleteReview(${review.reviewId})">Xóa</button>
                            </div>
                            `
                    : ""
            }
                </div>
            </div>
            `
        }

        const renderReviews = (reviewList) => {
            const prevBtn = document.querySelector("#review-pagination .paginationjs-prev a");
            const nextBtn = document.querySelector("#review-pagination .paginationjs-next a");
            if (prevBtn) {
                prevBtn.innerHTML = `<i class="fa fa-long-arrow-left"></i>`;
            }
            if (nextBtn) {
                nextBtn.innerHTML = `<i class="fa fa-long-arrow-right"></i>`;
            }
            const reviewListEl = document.querySelector(".review-list");
            reviewListEl.innerHTML = "";
            let html = "";
            reviewList.forEach(review => {
                html += renderReview(review);
            })
            reviewListEl.innerHTML = html;

            renderOverview();
        }

        const renderOverview = () => {
            const reviewCount = document.querySelectorAll(".review-count");
            reviewCount.forEach(el => {
                el.innerText = reviews.length;
            })

            renderOverviewAvg();
            renderOverviewProgress();
        }

        const renderOverviewAvg = () => {
            // calcaulate avg rating
            let avgRating = 0;
            reviews.forEach(review => {
                avgRating += review.rating;
            })
            avgRating = Math.round(avgRating / reviews.length);

            // render star based on rating number
            const ratingHtmlEl = document.querySelector(".overview-avg .rating");
            const productDetailRatingHtmlEl = document.querySelector(".product__details__rating .rating");
            ratingHtmlEl.innerHTML = "";
            productDetailRatingHtmlEl.innerHTML = "";
            let ratingHtml = "";
            for (let i = 0; i < 5; i++) {
                if (i < avgRating) {
                    ratingHtml += `<span class="active"><i class="fa fa-star"></i></span>`
                } else {
                    ratingHtml += `<span class="unactive"><i class="fa fa-star"></i></span>`
                }
            }
            ratingHtmlEl.innerHTML = ratingHtml;
            productDetailRatingHtmlEl.innerHTML = ratingHtml;

            // render avg rating
            const avgRatingEl = document.querySelector(".overview-avg h2");
            avgRatingEl.innerText = `${avgRating}/5`;

            // render count rating
            const countRatingEl = document.querySelector(".overview-avg .review-count");
            countRatingEl.innerText = reviews.length;
        }

        const renderOverviewProgress = () => {
            const ratingArr = [5, 4, 3, 2, 1];
            const ratingCount = [0, 0, 0, 0, 0];

            ratingArr.forEach((el, index) => {
                reviews.forEach(review => {
                    if (review.rating === el) {
                        ratingCount[index]++;
                    }
                })
            })

            const progressBlockEl = document.querySelector(".overview-progress .progress-block");
            progressBlockEl.innerHTML = "";
            let html = "";
            ratingArr.forEach((el, index) => {
                html += `
                    <div class="progress-item d-flex align-items-center w-100 mb-1">
                        <span class="mr-1">${el}</span>
                        <span class="mr-1 rating"><i class="fa fa-star"></i></span>
                        <div class="flex-grow-1 progress progress-success progress-sm progress-line">
                            <div class="progress-bar" style="width: ${ratingCount[index] * 100 / reviews.length}%;"></div>
                        </div>
                        <span class="ml-1">${ratingCount[index]}</span>
                    </div>
                `
            })
            progressBlockEl.innerHTML = html;
        }

        const renderPagination = () => {
            $('#review-pagination').pagination({
                dataSource: reviews,
                pageSize: 5,
                autoHidePrevious: true,
                autoHideNext: true,
                callback: function (data, pagination) {
                    console.log(pagination)
                    renderReviews(data);
                },
                hideOnlyOnePage: true,
            })
        }

        $('#modal-review').on('hidden.bs.modal', function (event) {
            // clear review content
            reviewContent.value = "";

            // clear rating message
            ratingMessage.textContent = "";

            // reset stars
            resetStars();

            idUpdate = null;
            isUpdate = false;
        })

        function openModalToUpdateReview(reviewId) {
            // find review by id
            const review = reviews.find(review => review.reviewId === reviewId);

            // set rating
            currentRating = review.rating;
            currentMessage = reviewMessage(currentRating);
            ratingMessage.textContent = `Bạn đã đánh giá ${currentRating} sao. (${currentMessage})`;
            highlightStars(currentRating);

            // set review content
            reviewContent.value = review.comment;

            // set id update
            idUpdate = reviewId;
            isUpdate = true;

            // open modal
            $('#modal-review').modal('show');
        }

        /*-------------------
            Handle review (create/update)
        --------------------- */
        const btnSendReview = document.querySelector("#btn-send-review");
        const reviewContent = document.querySelector("#review-content");
        btnSendReview.addEventListener("click", () => {
            if (isUpdate) {
                updateReview(idUpdate);
            } else {
                createReview();
            }
        })

        /*-------------------
            Create review
        --------------------- */
        const createReview = () => {
            const review = {
                productId: product.productId,
                rating: currentRating,
                comment: reviewContent.value
            }

            // Send request to server using axios
            axios.post("/api/v1/reviews", review)
                .then(res => {
                    // add review to reviews array
                    reviews.unshift(res.data);
                    renderPagination();

                    toastr.success("Đánh giá thành công");
                    currentRating = 0;
                    currentMessage = "";

                    // close modal
                    $('#modal-review').modal('hide');
                })
                .catch(err => {
                    console.log(err);
                    toastr.error("Đánh giá thất bại");
                })
        }

        /*-------------------
            Delete review
        --------------------- */
        const deleteReview = id => {
            const isDelete = confirm("Bạn có chắc chắn muốn xóa đánh giá này?");
            if (!isDelete) {
                return;
            }
            // Send request to server using axios
            axios.delete(`/api/v1/reviews/${id}`)
                .then(res => {
                    // delete review in reviews array
                    const index = reviews.findIndex(review => review.reviewId === id);
                    reviews.splice(index, 1);
                    renderPagination();

                    toastr.success("Xóa đánh giá thành công");
                })
                .catch(err => {
                    console.log(err);
                    toastr.error("Xóa đánh giá thất bại");
                })
        }


        /*-------------------
            Update review
        --------------------- */
        const updateReview = id => {
            const review = {
                rating: currentRating,
                comment: reviewContent.value
            }

            // Send request to server using axios
            axios.put(`/api/v1/reviews/${id}`, review)
                .then(res => {
                    // update review in reviews array
                    const index = reviews.findIndex(review => review.reviewId === id);
                    reviews[index] = res.data;
                    renderPagination();

                    toastr.success("Cập nhật đánh giá thành công");
                    currentRating = 0;
                    currentMessage = "";

                    // close modal
                    $('#modal-review').modal('hide');
                })
                .catch(err => {
                    console.log(err);
                    toastr.error("Cập nhật đánh giá thất bại");
                })
        }

        renderPagination();
    </script>
</th:block>
</body>

</html>